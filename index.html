<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Trader: MOEX Real-Time</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #121212;
            --text-main: #e0e0e0;
            --accent-green: #00e676;
            --accent-red: #ff1744;
            --accent-blue: #2979ff;
            --border: #333;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 12px;
            padding-bottom: 100px;
        }

        h1 {
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 0 20px 0;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
        }

        /* Settings */
        .settings-panel {
            background: #1a1a1a;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .input-group input, .input-group select {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-start { background: var(--accent-green); color: #000; }
        .btn-stop { background: var(--accent-red); color: #fff; }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Status */
        .status-bar {
            text-align: center;
            font-family: monospace;
            color: #666;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        /* Cards */
        .grid { display: grid; gap: 12px; }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #222;
            padding-bottom: 8px;
        }

        .asset-info { display: flex; flex-direction: column; }
        .asset-title { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .asset-code { font-size: 0.75rem; color: #666; font-family: monospace; }

        .price-box { text-align: right; }
        .price-val { font-size: 1.1rem; font-weight: bold; font-family: monospace; }
        .price-change { font-size: 0.8rem; font-weight: bold; }
        
        .p-up { color: var(--accent-green); }
        .p-down { color: var(--accent-red); }

        .signal-badge {
            display: block;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-weight: 900;
            font-size: 1.1rem;
            text-transform: uppercase;
            margin: 10px 0;
            background: #222;
            color: #555;
            border: 1px solid #333;
        }

        .sig-long { background: rgba(0, 230, 118, 0.15); color: var(--accent-green); border-color: var(--accent-green); }
        .sig-short { background: rgba(255, 23, 68, 0.15); color: var(--accent-red); border-color: var(--accent-red); }

        .ai-text {
            font-size: 0.85rem;
            color: #bbb;
            line-height: 1.4;
            background: #080808;
            padding: 10px;
            border-radius: 6px;
        }

        .levels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .lvl-sl { color: #ff5252; }
        .lvl-tp { color: #69f0ae; }

        .loader { display: none; text-align: center; color: var(--accent-blue); padding: 10px; }
        
        .error-msg { color: var(--accent-red); font-size: 0.8rem; display: none; text-align: center;}
    </style>
</head>
<body>

    <h1>MOEX Real-Time + AI</h1>

    <div class="settings-panel">
        <div class="input-group">
            <label>OpenRouter API Key:</label>
            <input type="password" id="apiKey" placeholder="sk-or-v1-..." autocomplete="off">
        </div>
        <div class="input-group">
            <label>AI –ú–æ–¥–µ–ª—å:</label>
            <select id="modelSelect">
                <option value="deepseek/deepseek-v3.2" selected>DeepSeek V3.2 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                <option value="deepseek/deepseek-r1">DeepSeek R1 (–£–º–Ω–∞—è)</option>
            </select>
        </div>
        <div class="controls">
            <button class="btn-start" onclick="startSystem()">START (5 min)</button>
            <button class="btn-stop" onclick="stopSystem()">STOP</button>
        </div>
        <div class="status-bar" id="status">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</div>
        <div class="error-msg" id="errorBox"></div>
    </div>

    <div id="loader" class="loader">üîÑ –ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ —Å –ú–æ—Å–±–∏—Ä–∂–∏...</div>

    <div class="grid" id="cards"></div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –¢–ò–ö–ï–†–û–í (–ú–ê–†–¢ 2026) ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–Ω–∏–º–∞–µ—Ç API MOEX ISS
        const INSTRUMENTS = [
            { code: 'SRH6', title: '–°–±–µ—Ä–±–∞–Ω–∫', view: 'SBRF-3.26' },
            { code: 'SiH6', title: '–î–æ–ª–ª–∞—Ä/–†—É–±–ª—å', view: 'Si-3.26' },
            { code: 'CRH6', title: '–Æ–∞–Ω—å/–†—É–±–ª—å', view: 'CNY-3.26' },
            { code: 'SVH6', title: '–°–µ—Ä–µ–±—Ä–æ', view: 'SILV-3.26' },
            { code: 'MXH6', title: '–ò–Ω–¥–µ–∫—Å MOEX', view: 'MIX-3.26' }
        ];

        let marketData = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω
        let timer = null;
        let countdown = null;
        const INTERVAL = 300000; // 5 –º–∏–Ω—É—Ç

        // --- INIT ---
        window.onload = () => {
            const key = localStorage.getItem('or_key');
            if(key) document.getElementById('apiKey').value = key;
            renderCards();
        };

        function renderCards() {
            const container = document.getElementById('cards');
            container.innerHTML = '';
            INSTRUMENTS.forEach(inst => {
                container.innerHTML += `
                    <div class="card" id="card-${inst.code}">
                        <div class="card-header">
                            <div class="asset-info">
                                <span class="asset-title">${inst.title}</span>
                                <span class="asset-code">${inst.view}</span>
                            </div>
                            <div class="price-box">
                                <div class="price-val" id="price-${inst.code}">---</div>
                                <div class="price-change" id="change-${inst.code}">0.00%</div>
                            </div>
                        </div>
                        <div class="signal-badge" id="sig-${inst.code}">–ñ–î–£ –î–ê–ù–ù–´–ï</div>
                        <div class="ai-text" id="text-${inst.code}">–ù–∞–∂–º–∏—Ç–µ START –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...</div>
                    </div>
                `;
            });
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function startSystem() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert('–ù—É–∂–µ–Ω API –∫–ª—é—á OpenRouter!');
            localStorage.setItem('or_key', key);

            document.querySelector('.btn-start').disabled = true;
            document.getElementById('status').innerText = '–ó–∞–ø—É—Å–∫...';
            document.getElementById('errorBox').style.display = 'none';

            runCycle();
            timer = setInterval(runCycle, INTERVAL);
        }

        function stopSystem() {
            clearInterval(timer);
            clearInterval(countdown);
            document.querySelector('.btn-start').disabled = false;
            document.getElementById('status').innerText = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }

        async function runCycle() {
            // 1. –°–Ω–∞—á–∞–ª–∞ –±–µ—Ä–µ–º —Ü–µ–Ω—ã —Å MOEX
            await fetchMoexData();
            
            // 2. –ü–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –≤ DeepSeek
            await getAiAnalysis();
            
            // 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            startCountdown(INTERVAL / 1000);
        }

        // --- –®–ê–ì 1: MOEX API (–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) ---
        async function fetchMoexData() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('status').innerText = 'üì° MOEX: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω...';

            for (let inst of INSTRUMENTS) {
                try {
                    // –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –ú–æ—Å–±–∏—Ä–∂–∏ (JSON)
                    const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${inst.code}.json`;
                    
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Network error');
                    
                    const json = await res.json();
                    
                    // –ü–∞—Ä—Å–∏–º —Å–ª–æ–∂–Ω—ã–π –æ—Ç–≤–µ—Ç MOEX ISS
                    // marketdata -> index 0 is columns, index 1 is data
                    const md = json.marketdata.data[0]; 
                    const cols = json.marketdata.columns;
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                    const idxLast = cols.indexOf('LAST'); // –ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞
                    const idxChange = cols.indexOf('LASTCHANGEPRCNT'); // –ò–∑–º–µ–Ω–µ–Ω–∏–µ %

                    const price = md[idxLast];
                    const change = md[idxChange];

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
                    marketData[inst.code] = {
                        price: price,
                        change: change
                    };

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å—Ä–∞–∑—É
                    updatePriceUI(inst.code, price, change);

                } catch (e) {
                    console.error(`–û—à–∏–±–∫–∞ MOEX –¥–ª—è ${inst.code}:`, e);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É, –Ω–æ –Ω–µ –ª–æ–º–∞–µ–º —Ü–∏–∫–ª
                    marketData[inst.code] = { price: 0, change: 0 };
                }
            }
        }

        function updatePriceUI(code, price, change) {
            const pEl = document.getElementById(`price-${code}`);
            const cEl = document.getElementById(`change-${code}`);

            if (price) {
                pEl.innerText = price.toLocaleString();
                cEl.innerText = (change > 0 ? '+' : '') + change + '%';
                
                // –¶–≤–µ—Ç
                cEl.className = 'price-change ' + (change >= 0 ? 'p-up' : 'p-down');
                pEl.style.color = (change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)');
            } else {
                pEl.innerText = 'ERR';
            }
        }

        // --- –®–ê–ì 2: DeepSeek AI (–ê–Ω–∞–ª–∏–∑) ---
        async function getAiAnalysis() {
            document.getElementById('status').innerText = 'üß† AI: –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞...';
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            // –§–æ—Ä–º–∏—Ä—É–µ–º —á–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏
            const dataString = INSTRUMENTS.map(i => {
                const d = marketData[i.code];
                return `${i.title} (${i.code}): –¶–µ–Ω–∞=${d.price}, –ò–∑–º=${d.change}%`;
            }).join('\n');

            const prompt = `
            –¢—ã —Å–∫–∞–ª—å–ø–µ—Ä-—Ä–æ–±–æ—Ç. –í–æ—Ç –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ —Å –±–∏—Ä–∂–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (${new Date().toLocaleTimeString()}):
            
            ${dataString}
            
            –ó–∞–¥–∞—á–∞: –ò—Å—Ö–æ–¥—è –ò–ú–ï–ù–ù–û –ò–ó –≠–¢–ò–• –¶–ò–§–†, –¥–∞–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –º–∏–Ω—É—Ç.
            –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ–∫–æ–ª–æ 0%, –ø–∏—à–∏ WAIT. –ï—Å–ª–∏ —Å–∏–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (>0.5%), —Ç–æ—Ä–≥—É–π –ø–æ —Ç—Ä–µ–Ω–¥—É.
            
            –û—Ç–≤–µ—Ç –°–¢–†–û–ì–û JSON –º–∞—Å—Å–∏–≤ (–±–µ–∑ markdown):
            [{
                "id": "SRH6",
                "action": "LONG/SHORT/WAIT",
                "reason": "–ö–æ—Ä–æ—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ",
                "sl": "–£—Ä–æ–≤–µ–Ω—å —Å—Ç–æ–ø–∞ (—á–∏—Å–ª–æ)",
                "tp": "–£—Ä–æ–≤–µ–Ω—å —Ç–µ–π–∫–∞ (—á–∏—Å–ª–æ)"
            }, ...]
            `;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json",
                        "X-Title": "MoexRealTime"
                    },
                    body: JSON.stringify({
                        "model": model,
                        "messages": [{"role": "user", "content": prompt}],
                        "temperature": 0.5
                    })
                });

                const json = await res.json();
                const content = json.choices[0].message.content;
                
                // –ü–∞—Ä—Å–∏–º JSON (–æ—á–∏—Å—Ç–∫–∞ –æ—Ç ```json)
                const cleanJson = content.replace(/```json/g, '').replace(/```/g, '').trim();
                const signals = JSON.parse(cleanJson);
                
                applySignals(signals);

            } catch (e) {
                console.error(e);
                document.getElementById('errorBox').innerText = '–û—à–∏–±–∫–∞ AI: ' + e.message;
                document.getElementById('errorBox').style.display = 'block';
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function applySignals(signals) {
            signals.forEach(s => {
                const card = document.getElementById(`card-${s.id}`);
                if (!card) return;

                const badge = document.getElementById(`sig-${s.id}`);
                const text = document.getElementById(`text-${s.id}`);
                const act = s.action.toUpperCase();

                // –°–±—Ä–æ—Å
                badge.className = 'signal-badge';
                
                if (act.includes('LONG')) {
                    badge.classList.add('sig-long');
                    badge.innerText = '–ü–û–ö–£–ü–ê–¢–¨ üöÄ';
                } else if (act.includes('SHORT')) {
                    badge.classList.add('sig-short');
                    badge.innerText = '–ü–†–û–î–ê–í–ê–¢–¨ üîª';
                } else {
                    badge.innerText = '–ù–ê–ë–õ–Æ–î–ï–ù–ò–ï üëÄ';
                    badge.style.borderColor = '#444';
                    badge.style.color = '#888';
                }

                text.innerHTML = `
                    ${s.reason}
                    <div class="levels">
                        <span class="lvl-sl">SL: ${s.sl}</span>
                        <span class="lvl-tp">TP: ${s.tp}</span>
                    </div>
                `;
            });
        }

        function startCountdown(sec) {
            const st = document.getElementById('status');
            clearInterval(countdown);
            countdown = setInterval(() => {
                st.innerText = `–°–ª–µ–¥. –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${sec--} —Å–µ–∫`;
                if (sec < 0) clearInterval(countdown);
            }, 1000);
        }
    </script>
</body>
</html>
