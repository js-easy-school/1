 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Trader v10.0 (Smart Trend)</title>
    <style>
        :root {
            --bg-color: #0b0c10;
            --card-bg: #1f2833;
            --text-main: #c5c6c7;
            --accent-green: #45a29e;
            --accent-red: #d9534f;
            --accent-yellow: #f0ad4e;
            --accent-blue: #66fcf1;
            --border: #45a29e;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            padding-bottom: 120px;
        }

        h1 {
            font-size: 1.2rem;
            text-align: center;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(102, 252, 241, 0.3);
        }

        /* Settings */
        .settings-panel {
            background: #14181c;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .input-group { margin-bottom: 12px; }
        
        input, select {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }

        .controls { display: flex; gap: 10px; }
        
        button {
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            cursor: pointer;
            padding: 15px;
            transition: 0.2s;
            flex: 1;
        }
        
        .btn-start { background: var(--accent-green); color: #000; box-shadow: 0 0 15px rgba(69, 162, 158, 0.4); }
        .btn-stop { background: #333; color: #fff; }
        .btn-sound { flex: 0.3; background: #222; font-size: 1.2rem; }
        .sound-on { color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card {
            background: var(--card-bg);
            border-left: 4px solid #333; /* Default border */
            border-radius: 8px;
            padding: 15px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        
        .card.buy-mode { border-left-color: var(--accent-green); }
        .card.sell-mode { border-left-color: var(--accent-red); }

        /* Card Content */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .asset-name { font-weight: bold; font-size: 1rem; color: #fff; }
        .asset-code { font-size: 0.7rem; color: #888; }
        .price-current { font-size: 1.1rem; font-weight: bold; font-family: monospace; color: #fff; }
        .price-change { font-size: 0.8rem; font-weight: bold; text-align: right; }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .action-badge {
            background: #111;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        .profit-badge {
            font-family: monospace;
            font-weight: bold;
            font-size: 1rem;
            padding: 6px 10px;
            border-radius: 4px;
            background: #000;
        }

        .txt-green { color: var(--accent-green); }
        .txt-red { color: var(--accent-red); }
        .txt-gray { color: #666; }

        .progress-container {
            height: 6px;
            background: #111;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        .progress-bar { height: 100%; transition: width 0.5s; }

        .ai-text { font-size: 0.8rem; color: #aaa; line-height: 1.4; margin-bottom: 8px; font-style: italic; }

        .meta-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #666;
            margin-top: 10px;
            border-top: 1px solid #333;
            padding-top: 5px;
        }

        .loader { display: none; text-align: center; padding: 20px; color: var(--accent-blue); font-size: 0.9rem; }
        .timer { text-align: center; color: #666; font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>AI TRADER v10.0 (Stable Trend)</h1>

    <div class="settings-panel">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ OpenRouter Key (sk-or-...)">
        </div>
        <div class="input-group">
            <select id="modelSelect">
                <option value="deepseek/deepseek-v3.2" selected>DeepSeek V3.2 (–°–∫–æ—Ä–æ—Å—Ç—å/–¶–µ–Ω–∞)</option>
                <option value="deepseek/deepseek-r1">DeepSeek R1 (–ú–∞–∫—Å. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç)</option>
                <option value="openai/gpt-4o-mini">GPT-4o Mini (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)</option>
            </select>
        </div>
        <div class="controls">
            <button class="btn-start" onclick="startSystem()">–ó–ê–ü–£–°–ö –¢–û–†–ì–û–í</button>
            <button class="btn-stop" onclick="stopSystem()">–°–¢–û–ü</button>
            <button class="btn-sound" id="soundBtn" onclick="toggleSound()">üîá</button>
        </div>
        <div class="timer" id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>

    <div id="loader" class="loader">
        üì° –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö MOEX...<br>
        üß† –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ H4/D1...<br>
        üõ°Ô∏è –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä—ã–Ω–æ—á–Ω–æ–≥–æ —à—É–º–∞...
    </div>
    
    <div class="grid" id="cards"></div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const ASSETS = [
            { code: 'SRH6', name: '–°–±–µ—Ä–±–∞–Ω–∫', desc: 'SBRF-3.26' },
            { code: 'SiH6', name: 'USD/RUB', desc: 'Si-3.26' },
            { code: 'CRH6', name: 'CNY/RUB', desc: 'CNY-3.26' },
            { code: 'EuH6', name: 'EUR/RUB', desc: 'Eu-3.26' },
            { code: 'GDH6', name: '–ó–æ–ª–æ—Ç–æ', desc: 'GOLD-3.26' },
            { code: 'SVH6', name: '–°–µ—Ä–µ–±—Ä–æ', desc: 'SILV-3.26' },
            { code: 'BRH6', name: '–ù–µ—Ñ—Ç—å Brent', desc: 'BR-3.26' },
            { code: 'NGH6', name: '–ì–∞–∑', desc: 'NG-3.26' },
            { code: 'WHH6', name: '–ü—à–µ–Ω–∏—Ü–∞', desc: 'WHEAT-3.26' },
            { code: 'MXH6', name: '–ò–Ω–¥–µ–∫—Å MOEX', desc: 'MIX-3.26' },
            { code: 'CCH6', name: '–ö–∞–∫–∞–æ', desc: 'COCOA-3.26' },
            { code: 'KCH6', name: '–ö–æ—Ñ–µ', desc: 'COFFEE-3.26' }
        ];

        let state = {
            market: {},     // –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            signals: {},    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã {action, prob, entryPrice}
            running: false,
            sound: false
        };

        let timerRef = null;
        let wakeLock = null;
        const UPDATE_INTERVAL = 300000; // 5 –º–∏–Ω—É—Ç (–ß—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å –º–∏–Ω—É—Ç–Ω—ã–π —à—É–º)

        window.onload = () => {
            const savedKey = localStorage.getItem('or_key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;
            renderGrid();
        };

        // --- UI RENDER ---
        function renderGrid() {
            const grid = document.getElementById('cards');
            grid.innerHTML = '';
            
            ASSETS.forEach(asset => {
                const s = state.signals[asset.code] || { action: 'WAIT', prob: 0, reason: '–û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞...' };
                const m = state.market[asset.code] || { price: 0, change: 0 };
                
                // –°—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–∫–∏
                let modeClass = '';
                if(s.action === 'BUY') modeClass = 'buy-mode';
                if(s.action === 'SELL') modeClass = 'sell-mode';

                // –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞/–ø—Ä–æ—Ñ–∏—Ç–∞
                let profitText = "0.0%";
                let profitClass = "txt-gray";
                
                if (s.entryPrice && m.price > 0 && s.action !== 'WAIT') {
                    let diff = 0;
                    if(s.action === 'BUY') diff = ((m.price - s.entryPrice) / s.entryPrice) * 100;
                    if(s.action === 'SELL') diff = ((s.entryPrice - m.price) / s.entryPrice) * 100;
                    
                    profitText = (diff > 0 ? '+' : '') + diff.toFixed(2) + '%';
                    profitClass = diff >= 0 ? 'txt-green' : 'txt-red';
                }

                grid.innerHTML += `
                    <div class="card ${modeClass}" id="card-${asset.code}">
                        <div class="card-header">
                            <div>
                                <div class="asset-name">${asset.name}</div>
                                <div class="asset-code">${asset.desc}</div>
                            </div>
                            <div>
                                <div class="price-current">${m.price || '---'}</div>
                                <div class="price-change" style="color: ${m.change >= 0 ? '#45a29e' : '#d9534f'}">
                                    ${m.change || 0}%
                                </div>
                            </div>
                        </div>

                        <div class="status-row">
                            <div class="action-badge" style="color: ${getActionColor(s.action)}">
                                ${s.action}
                            </div>
                            <div class="profit-badge ${profitClass}">
                                ${profitText}
                            </div>
                        </div>

                        <div class="ai-text">${s.reason}</div>

                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${s.prob}%; background: ${getActionColor(s.action)}"></div>
                        </div>

                        <div class="meta-info">
                            <span>–°–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞: ${s.prob}%</span>
                            <span>Target: ${s.tp || '---'}</span>
                        </div>
                    </div>
                `;
            });
        }

        function getActionColor(action) {
            if(action === 'BUY') return 'var(--accent-green)';
            if(action === 'SELL') return 'var(--accent-red)';
            return '#666';
        }

        // --- CORE LOGIC ---

        async function startSystem() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!');
            localStorage.setItem('or_key', key);
            
            state.running = true;
            document.querySelector('.btn-start').innerText = '–†–ê–ë–û–¢–ê–ï–¢...';
            document.querySelector('.btn-start').disabled = true;

            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}

            runCycle();
            timerRef = setInterval(runCycle, UPDATE_INTERVAL);
        }

        function stopSystem() {
            state.running = false;
            clearInterval(timerRef);
            if(wakeLock) wakeLock.release();
            document.querySelector('.btn-start').innerText = '–ó–ê–ü–£–°–ö –¢–û–†–ì–û–í';
            document.querySelector('.btn-start').disabled = false;
            document.getElementById('statusText').innerText = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }

        async function runCycle() {
            if(!state.running) return;
            
            document.getElementById('loader').style.display = 'block';
            
            await fetchMoexData();
            await analyzeMarket(); // –¢–µ–ø–µ—Ä—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π!
            
            renderGrid();
            document.getElementById('loader').style.display = 'none';
            startCountdown(UPDATE_INTERVAL / 1000);
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ–ª–∏–∫–≤–∏–¥–∞)
        async function fetchMoexData() {
            for (let asset of ASSETS) {
                try {
                    const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${asset.code}.json`;
                    const res = await fetch(url);
                    const json = await res.json();
                    
                    const find = (block, names) => {
                        if(!block || !block.data.length) return null;
                        for(let name of names) {
                            let idx = block.columns.indexOf(name);
                            if(idx > -1 && block.data[0][idx] != null) return block.data[0][idx];
                        }
                        return null;
                    };

                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–¥–µ–ª–∫–∏ -> –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫
                    let price = find(json.marketdata, ['LAST', 'THEORPRICE']) || 
                                find(json.securities, ['PREVPRICE', 'THEORPRICE', 'SETTLEMENTPRICE']) || 0;
                    
                    let change = find(json.marketdata, ['LASTCHANGEPRCNT']) || 0;
                    let high = find(json.marketdata, ['HIGH']) || price;
                    let low = find(json.marketdata, ['LOW']) || price;

                    state.market[asset.code] = { price, change, high, low };

                } catch (e) {
                    console.log(`Error ${asset.code}`);
                    state.market[asset.code] = { price: 0, change: 0, high: 0, low: 0 };
                }
            }
        }

        async function analyzeMarket() {
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            // –§–æ—Ä–º–∏—Ä—É–µ–º —É–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ü–ê–ú–Ø–¢–¨–Æ
            const assetsPrompt = ASSETS.map(a => {
                const m = state.market[a.code];
                const prev = state.signals[a.code] || { action: 'WAIT' };
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–Ω—è
                let rangePos = 50;
                if(m.high !== m.low) rangePos = ((m.price - m.low) / (m.high - m.low)) * 100;

                return `
                ASSET: ${a.name} (${a.code})
                - Price: ${m.price}
                - Day Change: ${m.change}%
                - Day Range Position: ${rangePos.toFixed(1)}% (0=Low, 100=High)
                - PREVIOUS SIGNAL: ${prev.action} (Don't flip-flop unless trend reverses!)
                `;
            }).join('\n');

            const systemPrompt = `
            –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Swing-—Ç—Ä–µ–π–¥–µ—Ä –∏ –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–µ—Ä.
            –¢–≤–æ—è —Ü–µ–ª—å: –ò–∑–±–µ–≥–∞—Ç—å —à—É–º–∞ –∏ –ª–æ–≤–∏—Ç—å —Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã (H4/D1).
            
            –ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
            1. –ò–ì–ù–û–†–ò–†–£–ô –º–µ–ª–∫–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è (—à—É–º). –ï—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å < 0.3% –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ -> KEEP PREVIOUS SIGNAL.
            2. –°–ò–ì–ù–ê–õ BUY: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (>60%) –ò –µ—Å—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞.
            3. –°–ò–ì–ù–ê–õ SELL: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ü–µ–Ω–∞ –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (<40%) –ò –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞.
            4. WAIT: –ï—Å–ª–∏ —Ä—ã–Ω–æ–∫ –≤–æ —Ñ–ª—ç—Ç–µ (Range Position 40-60%) –∏–ª–∏ —Ç—Ä–µ–Ω–¥ –Ω–µ—è—Å–µ–Ω.
            5. –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨: –ï—Å–ª–∏ –ø—Ä–æ—à–ª—ã–π —Å–∏–≥–Ω–∞–ª –±—ã–ª BUY, –Ω–µ –º–µ–Ω—è–π –Ω–∞ SELL —Å—Ä–∞–∑—É. –°–Ω–∞—á–∞–ª–∞ WAIT.
            
            –í—ã–¥–∞–π –æ—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ JSON:
            [{
                "id": "TICKER",
                "action": "BUY/SELL/WAIT",
                "prob": 0-100,
                "reason": "–ö—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–¢—Ä–µ–Ω–¥ –≤–≤–µ—Ä—Ö/–ü—Ä–æ–±–æ–π —É—Ä–æ–≤–Ω—è/–§–ª—ç—Ç)",
                "tp": price_number
            }, ...]
            `;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: assetsPrompt }
                        ],
                        temperature: 0.3 // –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                    })
                });

                const data = await res.json();
                let cleanJson = data.choices[0].message.content.replace(/```json|```/g, '');
                const results = JSON.parse(cleanJson);

                let audioTrigger = false;

                results.forEach(res => {
                    const oldSignal = state.signals[res.id];
                    const currentPrice = state.market[res.id].price;

                    // –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
                    let entry = oldSignal ? oldSignal.entryPrice : currentPrice;
                    
                    // –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª —Å–º–µ–Ω–∏–ª—Å—è (BUY -> SELL –∏–ª–∏ WAIT -> BUY), –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
                    if (oldSignal && oldSignal.action !== res.action && res.action !== 'WAIT') {
                        entry = currentPrice;
                        if(res.prob > 60) audioTrigger = true;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–π—Ç
                    state.signals[res.id] = {
                        action: res.action,
                        prob: res.prob,
                        reason: res.reason,
                        tp: res.tp,
                        entryPrice: entry
                    };
                });

                if(audioTrigger && state.sound) playAlert();

            } catch (e) {
                console.error("AI Error:", e);
            }
        }

        // --- UTILS ---
        function toggleSound() {
            state.sound = !state.sound;
            const btn = document.getElementById('soundBtn');
            btn.innerText = state.sound ? 'üîî' : 'üîá';
            if(state.sound) btn.classList.add('sound-on');
            else btn.classList.remove('sound-on');
        }

        function playAlert() {
            document.getElementById('alertSound').play().catch(e => console.log(e));
        }

        function startCountdown(seconds) {
            const el = document.getElementById('statusText');
            clearInterval(window.countdownInt);
            window.countdownInt = setInterval(() => {
                seconds--;
                el.innerText = `–°–ª–µ–¥—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑: ${seconds} —Å–µ–∫`;
                if(seconds <= 0) clearInterval(window.countdownInt);
            }, 1000);
        }
    </script>
</body>
</html>
